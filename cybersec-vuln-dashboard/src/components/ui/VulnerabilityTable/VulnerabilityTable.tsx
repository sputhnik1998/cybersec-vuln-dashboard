import {
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableRow,
  Paper,
  Box,
  Typography,
  CircularProgress,
} from '@mui/material';
import type { SelectChangeEvent } from '@mui/material';
import { useState, useEffect } from 'react';
import { useAppDispatch, useAppSelector } from '../../../store';
import { fetchVulnerabilities, setSorting } from '../../../store/vulnerabilitiesSlice';
import { VulnerabilityTableHeader } from './TableHeader';
import { VulnerabilityRow } from './VulnerabilityRow';
import { TablePagination } from './TablePagination';
import type { SortableColumn, VulnerabilityTableProps } from './types';
import './VulnerabilityTable.css';

const MAX_PAGE_JUMP = 10;

export const VulnerabilityTable = ({ initialLimit = 25 }: VulnerabilityTableProps) => {
  const dispatch = useAppDispatch();
  const [page, setPage] = useState(1);
  const [rowsPerPage, setRowsPerPage] = useState(initialLimit);

  // Get data from Redux store
  const { items: vulnerabilities, pagination, loading, error, sortBy, sortOrder } = useAppSelector(
    (state) => state.vulnerabilities
  );

  const totalCount = pagination?.totalCount ?? 0;
  const totalPages = pagination?.totalPages ?? 0;

  // Fetch data when dependencies change
  useEffect(() => {
    dispatch(
      fetchVulnerabilities({
        page,
        limit: rowsPerPage,
        sortBy,
        order: sortOrder,
      })
    );
  }, [dispatch, page, rowsPerPage, sortBy, sortOrder]);

  // Handle page navigation with max jump validation
  const handleChangePage = (newPage: number) => {
    if (newPage < 1 || newPage > totalPages || loading) return;

    if (Math.abs(newPage - page) > MAX_PAGE_JUMP) {
      alert(`You can only jump a maximum of ${MAX_PAGE_JUMP} pages at a time. Please navigate incrementally.`);
      return;
    }

    setPage(newPage);
  };

  // Handle rows per page change
  const handleChangeRowsPerPage = (event: SelectChangeEvent<number>) => {
    const newLimit = Number(event.target.value);
    setRowsPerPage(newLimit);
    setPage(1);
  };

  // Handle column sorting
  const handleSort = (column: SortableColumn) => {
    const isAsc = sortBy === column && sortOrder === 'asc';
    const newOrder = isAsc ? 'desc' : 'asc';

    dispatch(setSorting({ sortBy: column, sortOrder: newOrder }));
    setPage(1);
  };

  // Loading state
  if (loading && vulnerabilities.length === 0) {
    return (
      <Box className="vulnerability-table__loading">
        <CircularProgress />
        <Typography variant="body2" sx={{ ml: 2 }}>
          Loading vulnerabilities...
        </Typography>
      </Box>
    );
  }

  // Error state
  if (error) {
    return (
      <Paper className="vulnerability-table__error">
        <Typography variant="body1" color="error">
          Error loading vulnerabilities: {error}
        </Typography>
      </Paper>
    );
  }

  return (
    <Box className="vulnerability-table">
      <TableContainer component={Paper} elevation={2}>
        <Table sx={{ tableLayout: 'fixed', width: '100%' }}>
          <VulnerabilityTableHeader sortBy={sortBy} sortOrder={sortOrder} onSort={handleSort} />

          <TableBody>
            {vulnerabilities && vulnerabilities.length > 0 ? (
              vulnerabilities.map((vuln, index) => (
                <VulnerabilityRow key={vuln._id} vulnerability={vuln} index={index} />
              ))
            ) : (
              <TableRow>
                <TableCell colSpan={7} align="center" sx={{ py: 8 }}>
                  <Typography variant="body1" color="text.secondary" sx={{ fontSize: '0.95rem' }}>
                    No vulnerabilities found
                  </Typography>
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </TableContainer>

      <TablePagination
        page={page}
        rowsPerPage={rowsPerPage}
        totalCount={totalCount}
        totalPages={totalPages}
        loading={loading}
        onPageChange={handleChangePage}
        onRowsPerPageChange={handleChangeRowsPerPage}
      />
    </Box>
  );
};
