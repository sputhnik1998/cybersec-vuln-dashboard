import { TableRow, TableCell, Typography, Chip } from '@mui/material';
import { useNavigate } from 'react-router-dom';
import { useAppDispatch } from '../../../store';
import { setScrollPosition } from '../../../store/vulnerabilitiesSlice';
import type { Vulnerability } from '../../../services/api';
import { SEVERITY_COLORS } from '../../../utils/severityConfig';
import type { SeverityLevel } from '../../../types/vulnerability';
import './VulnerabilityRow.css';

interface VulnerabilityRowProps {
  vulnerability: Vulnerability;
  index: number;
}

const getSeverityColor = (severity: string): string => {
  return SEVERITY_COLORS[severity as SeverityLevel] || '#666';
};

const formatDate = (dateString?: Date): string => {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
};

export const VulnerabilityRow = ({ vulnerability, index }: VulnerabilityRowProps) => {
  const navigate = useNavigate();
  const dispatch = useAppDispatch();

  const handleCVEClick = () => {
    dispatch(setScrollPosition(window.scrollY));
    navigate(`/dashboard/cve/${vulnerability._id}`);
  };

  return (
    <TableRow
      hover
      className={`vulnerability-row ${index % 2 === 0 ? 'vulnerability-row--even' : 'vulnerability-row--odd'}`}
    >
      <TableCell className="vulnerability-row__cell">
        <Typography
          variant="body1"
          onClick={handleCVEClick}
          className="vulnerability-row__cve"
        >
          {vulnerability.cve}
        </Typography>
      </TableCell>

      <TableCell className="vulnerability-row__cell">
        <Chip
          label={vulnerability.severity.toUpperCase()}
          size="medium"
          className="vulnerability-row__severity-chip"
          sx={{ backgroundColor: getSeverityColor(vulnerability.severity) }}
        />
      </TableCell>

      <TableCell className="vulnerability-row__cell">
        <Typography variant="body1" className="vulnerability-row__cvss">
          {vulnerability.cvss || 'N/A'}
        </Typography>
      </TableCell>

      <TableCell className="vulnerability-row__cell">
        <Typography
          variant="body1"
          className="vulnerability-row__package"
        >
          {vulnerability.packageName}
        </Typography>
      </TableCell>

      <TableCell className="vulnerability-row__cell">
        <Typography variant="body1" color="text.secondary" className="vulnerability-row__text">
          {vulnerability.packageVersion || 'N/A'}
        </Typography>
      </TableCell>

      <TableCell className="vulnerability-row__cell">
        <Typography variant="body1" color="text.secondary" className="vulnerability-row__text">
          {formatDate(vulnerability.published)}
        </Typography>
      </TableCell>

      <TableCell className="vulnerability-row__cell">
        <Typography
          variant="body1"
          color="text.secondary"
          className="vulnerability-row__status"
        >
          {vulnerability.status || 'N/A'}
        </Typography>
      </TableCell>
    </TableRow>
  );
};
