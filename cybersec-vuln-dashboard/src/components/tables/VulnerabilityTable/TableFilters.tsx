import { useState } from 'react';
import { Box, Button, Paper } from '@mui/material';
import FilterListIcon from '@mui/icons-material/FilterList';
import AssessmentIcon from '@mui/icons-material/Assessment';
import PsychologyIcon from '@mui/icons-material/Psychology';
import { SearchField } from './SearchField';
import { SelectFilter } from './SelectFilter';
import { AnalysisToggle } from './AnalysisToggle';
import {
  SEVERITY_OPTIONS,
  STATUS_OPTIONS,
  formatSeverityOption,
  formatStatusOption,
  buildKaiStatusFilter,
} from './filterUtils';
import type { FilterValues } from '../../../types';
import './TableFilters.css';

interface TableFiltersProps {
  filters: FilterValues;
  onFilterChange: (filters: FilterValues) => void;
  onApplyFilters: (filters?: FilterValues) => void;
  onClearFilters: () => void;
}

export const TableFilters = ({
  filters,
  onFilterChange,
  onApplyFilters,
  onClearFilters,
}: TableFiltersProps) => {
  const [localFilters, setLocalFilters] = useState(filters);
  const [excludeInvalidNorisk, setExcludeInvalidNorisk] = useState(false);
  const [excludeAiInvalidNorisk, setExcludeAiInvalidNorisk] = useState(false);

  const updateFilter = (field: keyof FilterValues, value: string) => {
    const newFilters = { ...localFilters, [field]: value };
    setLocalFilters(newFilters);
    onFilterChange(newFilters);
  };

  const handleAnalysisToggle = (event: React.ChangeEvent<HTMLInputElement>) => {
    const checked = event.target.checked;
    setExcludeInvalidNorisk(checked);
    const newKaiStatus = buildKaiStatusFilter(checked, excludeAiInvalidNorisk);
    const newFilters = { ...localFilters, kaiStatus: newKaiStatus };
    setLocalFilters(newFilters);
    onFilterChange(newFilters);
    onApplyFilters(newFilters);
  };

  const handleAIAnalysisToggle = (event: React.ChangeEvent<HTMLInputElement>) => {
    const checked = event.target.checked;
    setExcludeAiInvalidNorisk(checked);
    const newKaiStatus = buildKaiStatusFilter(excludeInvalidNorisk, checked);
    const newFilters = { ...localFilters, kaiStatus: newKaiStatus };
    setLocalFilters(newFilters);
    onFilterChange(newFilters);
    onApplyFilters(newFilters);
  };

  const handleClear = () => {
    setLocalFilters({ severity: '', status: '', packageName: '', cve: '', kaiStatus: '' });
    setExcludeInvalidNorisk(false);
    setExcludeAiInvalidNorisk(false);
    onClearFilters();
  };

  const hasActiveFilters = Object.values(localFilters).some((value) => value !== '');

  return (
    <Paper
      elevation={2}
      sx={{ p: 3, mb: 3, backgroundColor: '#1a1a1a', border: '1px solid rgba(255, 255, 255, 0.1)' }}
    >
      {/* Header */}
      <Box sx={{ display: 'flex', alignItems: 'center', mb: 2.5 }}>
        <FilterListIcon sx={{ mr: 1, color: 'primary.main' }} />
        <Box sx={{ fontSize: '1.1rem', fontWeight: 600, color: 'text.primary' }}>
          Filter Vulnerabilities
        </Box>
      </Box>

      {/* Filters Container */}
      <Box
        sx={{
          display: 'grid',
          gridTemplateColumns: {
            xs: '1fr',
            sm: 'repeat(2, 1fr)',
            md: 'repeat(3, 1fr)',
            lg: 'repeat(5, 1fr)',
          },
          gap: 2,
          mb: 2,
        }}
      >
        {/* Search Fields */}
        <SearchField
          label="CVE ID"
          value={localFilters.cve}
          placeholder="Search CVE..."
          onChange={(e) => updateFilter('cve', e.target.value)}
          onClear={() => updateFilter('cve', '')}
        />

        <SearchField
          label="Package Name"
          value={localFilters.packageName}
          placeholder="Search package..."
          onChange={(e) => updateFilter('packageName', e.target.value)}
          onClear={() => updateFilter('packageName', '')}
        />

        {/* Dropdown Filters */}
        <SelectFilter
          label="Severity"
          value={localFilters.severity}
          options={SEVERITY_OPTIONS}
          onChange={(e) => updateFilter('severity', e.target.value)}
          formatOption={formatSeverityOption}
        />

        <SelectFilter
          label="Status"
          value={localFilters.status}
          options={STATUS_OPTIONS}
          onChange={(e) => updateFilter('status', e.target.value)}
          formatOption={formatStatusOption}
        />

        {/* Action Buttons */}
        <Box sx={{ display: 'flex', gap: 1, alignItems: 'center' }}>
          <Button
            fullWidth
            variant="contained"
            onClick={() => onApplyFilters()}
            sx={{ textTransform: 'none', fontWeight: 600, fontSize: '0.875rem', height: '40px' }}
          >
            Apply
          </Button>
          <Button
            fullWidth
            variant="outlined"
            onClick={handleClear}
            disabled={!hasActiveFilters}
            sx={{ textTransform: 'none', fontWeight: 600, fontSize: '0.875rem', height: '40px' }}
          >
            Clear
          </Button>
        </Box>
      </Box>

      {/* Analysis Toggles */}
      <Box
        sx={{
          display: 'flex',
          gap: 3,
          pt: 2,
          borderTop: '1px solid rgba(255, 255, 255, 0.1)',
          flexWrap: 'wrap',
        }}
      >
        <AnalysisToggle
          checked={excludeInvalidNorisk}
          onChange={handleAnalysisToggle}
          label="Exclude Kai Analysis Results"
          tooltip="Exclude vulnerabilities marked as 'invalid - norisk' from analysis results"
          color="#667eea"
          icon={AssessmentIcon}
        />
        <AnalysisToggle
          checked={excludeAiInvalidNorisk}
          onChange={handleAIAnalysisToggle}
          label="Exclude AI Kai Analysis Results"
          tooltip="Exclude vulnerabilities marked as 'ai-invalid-norisk' from AI analysis results"
          color="#f5576c"
          icon={PsychologyIcon}
        />
      </Box>
    </Paper>
  );
};
